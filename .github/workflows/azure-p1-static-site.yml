# Name for this workflow
name: Deploy Portfolio Website (Azure)

# This tells GitHub *when* to run this workflow
on:
  # Run it on any push to the 'main' branch
  push:
    branches: [ "main" ]
    # But *only* if the files that changed are in this project's folder
    paths:
      - 'azure/project-1-static-site/**'

# The actual jobs to run
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # Use a standard Linux runner
    
    # Set the default directory for all 'run' steps
    defaults:
      run:
        working-directory: ./azure/project-1-static-site/terraform

    steps:
    # 1. Get the code from our repo
    - name: Checkout Repo Code
      uses: actions/checkout@v4

    # 2. Log into Azure using the 'robot' credentials
    - name: Sign in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }} # This pulls the secret from GitHub settings

    # 3. Install Terraform on the runner
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    # 4. Connect Terraform to our remote state file in Azure
    - name: Terraform Init
      run: terraform init

    # 5. Build the infrastructure (or update it if it already exists)
    - name: Terraform Apply
      run: terraform apply -auto-approve

    # 6. Get the outputs from Terraform (like the storage account name/key)
    - name: Get Terraform Outputs
      id: tf-outputs
      run: |
        echo "storage_name=$(terraform output -raw storage_account_name)" >> $GITHUB_OUTPUT
        echo "storage_key=$(terraform output -raw -no-color storage_account_primary_key)" >> $GITHUB_OUTPUT
    
    # 7. Upload the HTML/CSS files from our 'src' folder to the '$web' container
    - name: Upload Site Files to $web
      uses: azure/CLI@v1
      env:
        # Pass the key to the 'az' command
        AZURE_STORAGE_KEY: ${{ steps.tf-outputs.outputs.storage_key }}
      with:
        inlineScript: |
          az storage blob upload-batch \
            --account-name ${{ steps.tf-outputs.outputs.storage_name }} \
            --source "azure/project-1-static-site/src" \
            --destination '$web' \
            --overwrite